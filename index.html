<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spotify Recommendations</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --spotify-green: #1DB954;
            --spotify-black: #191414;
            --spotify-gray: #535353;
        }

        body, html {
            margin: 0;
            padding: 0;
            font-family: 'Circular', 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--spotify-black);
            color: white;
            height: 100%;
            overflow: hidden;
        }

        #app {
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        #search-container {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            background-color: rgba(25, 20, 20, 0.8);
        }

        #artist-input {
            width: 60%;
            padding: 10px;
            font-size: 16px;
            border: none;
            border-radius: 5px;
            margin-right: 10px;
        }

        #search-btn {
            background-color: var(--spotify-green);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }

        #search-btn:hover {
            background-color: #1aa34a;
        }

        #track-container {
            flex-grow: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        .track {
            position: absolute;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: transform 0.3s ease-out;
        }

        #album-cover {
            width: 80vw;
            height: 80vw;
            max-width: 300px;
            max-height: 300px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            margin-bottom: 20px;
        }

        #track-info {
            text-align: center;
            padding: 0 20px;
        }

        #track-name {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        #track-artist {
            font-size: 18px;
            color: #A0A0A0;
        }

        #controls {
            display: flex;
            justify-content: space-around;
            padding: 20px;
            background-color: rgba(25, 20, 20, 0.8);
        }

        .control-btn {
            background-color: transparent;
            border: none;
            color: white;
            font-size: 24px;
            padding: 10px;
            cursor: pointer;
        }

        #like-btn, #dislike-btn {
            position: absolute;
            bottom: 80px;
            right: 20px;
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        #dislike-btn {
            bottom: 140px;
        }

        #login-button {
            display: block;
            width: 80%;
            max-width: 300px;
            margin: 20px auto;
            padding: 15px;
            font-size: 18px;
            background-color: var(--spotify-green);
            color: white;
            border: none;
            border-radius: 30px;
            cursor: pointer;
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- Campo para buscar canciones similares -->
        <div id="search-container">
            <input type="text" id="artist-input" placeholder="Buscar por grupo o artista">
            <button id="search-btn">Buscar recomendaciones</button>
        </div>

        <div id="track-container">
            <div class="track">
                <img id="album-cover" src="/placeholder.svg" alt="Album Cover">
                <div id="track-info">
                    <div id="track-name"></div>
                    <div id="track-artist"></div>
                </div>
            </div>
        </div>
        <button id="like-btn" class="control-btn hidden"><i class="fas fa-heart"></i></button>
        <button id="dislike-btn" class="control-btn hidden"><i class="fas fa-times"></i></button>
        <div id="controls" class="hidden">
            <button id="prev-btn" class="control-btn"><i class="fas fa-step-backward"></i></button>
            <button id="play-pause-btn" class="control-btn"><i class="fas fa-play"></i></button>
            <button id="next-btn" class="control-btn"><i class="fas fa-step-forward"></i></button>
        </div>
        <button id="login-button">Login with Spotify</button>
    </div>

    <script>
        const clientId = 'b6a4fbf9f4fc4646b8862fc9d157d071';
        const redirectUri = 'https://mguibas.github.io/Spotify-songs-recomendation-page/';
        const scopes = 'user-top-read user-read-recently-played playlist-modify-private playlist-read-private';

        let accessToken;
        let userId;
        let playlistId;
        let currentTrackIndex = -1;
        let tracks = [];
        let likedTracks = [];
        let dislikedTracks = [];
        let audio = new Audio();

        function login() {
            const authUrl = `https://accounts.spotify.com/authorize?response_type=token&client_id=${clientId}&redirect_uri=${encodeURIComponent(redirectUri)}&scope=${encodeURIComponent(scopes)}`;
            window.location.href = authUrl;
        }

        function getAccessTokenFromUrl() {
            const params = new URLSearchParams(window.location.hash.replace('#', '?'));
            return params.get('access_token');
        }

        async function fetchWebApi(endpoint, method, body) {
            if (!accessToken) {
                console.error('No access token available');
                return null;
            }
            try {
                const res = await fetch(`https://api.spotify.com/${endpoint}`, {
                    headers: {
                        Authorization: `Bearer ${accessToken}`,
                    },
                    method,
                    body: JSON.stringify(body)
                });
                if (!res.ok) throw new Error(`HTTP error! Status: ${res.status}`);
                return await res.json();
            } catch (error) {
                console.error('Error fetching API:', error);
                return null;
            }
        }

        async function getUserId() {
            if (!userId) {
                const userData = await fetchWebApi('v1/me', 'GET');
                if (userData) userId = userData.id;
            }
            return userId;
        }

        async function getOrCreatePlaylist() {
            if (!playlistId) {
                const playlists = await fetchWebApi('v1/me/playlists', 'GET');
                if (playlists) {
                    const playlist = playlists.items.find(pl => pl.name === 'Recomendaciones Spotify');
                    
                    if (playlist) {
                        playlistId = playlist.id;
                    } else {
                        const newPlaylist = await fetchWebApi(`v1/users/${await getUserId()}/playlists`, 'POST', {
                            name: 'Recomendaciones Spotify',
                            description: 'Playlist creada automáticamente para canciones de la web que ha hecho marquitos, Miau',
                            public: false
                        });
                        if (newPlaylist) playlistId = newPlaylist.id;
                    }
                }
            }
            return playlistId;
        }

        async function saveToPlaylist() {
            const track = tracks[currentTrackIndex];
            if (!track) return;
            const playlist = await getOrCreatePlaylist();
            await fetchWebApi(`v1/playlists/${playlist}/tracks`, 'POST', {
                uris: [track.uri]
            });
            console.log(`Saved to playlist: ${track.name} by ${track.artists.map(artist => artist.name).join(', ')}`);
        }

        async function getRecommendedTracks(seedTracks) {
            const seed = seedTracks.map(track => track.id).join(',');
            try {
                const recommendations = await fetchWebApi(`v1/recommendations?limit=10&seed_tracks=${seed}`, 'GET');
                if (recommendations) return recommendations.tracks.filter(track => track.preview_url && !dislikedTracks.includes(track.id));
            } catch (error) {
                console.error('Error getting recommended tracks:', error);
            }
            return [];
        }

        function playTrack(track) {
            audio.src = track.preview_url;
            audio.play();
            document.getElementById('track-name').textContent = track.name;
            document.getElementById('track-artist').textContent = track.artists.map(artist => artist.name).join(', ');
            document.getElementById('album-cover').src = track.album.images[0]?.url || '/placeholder.svg';
            document.getElementById('like-btn').classList.remove('hidden');
            document.getElementById('dislike-btn').classList.remove('hidden');
        }

        function playNext() {
            currentTrackIndex++;
            if (currentTrackIndex < tracks.length) {
                playTrack(tracks[currentTrackIndex]);
            } else {
                document.getElementById('like-btn').classList.add('hidden');
                document.getElementById('dislike-btn').classList.add('hidden');
                document.getElementById('track-name').textContent = 'No hay más recomendaciones';
                document.getElementById('track-artist').textContent = '';
                document.getElementById('album-cover').src = '/placeholder.svg';
            }
        }

        async function searchForArtist(artistName) {
            try {
                const searchResult = await fetchWebApi(`v1/search?q=${encodeURIComponent(artistName)}&type=artist&limit=1`, 'GET');
                const artist = searchResult.artists.items[0];
                if (!artist) {
                    alert("Artista no encontrado");
                    return;
                }
                const topTracks = await fetchWebApi(`v1/artists/${artist.id}/top-tracks?market=US`, 'GET');
                if (topTracks) {
                    const seedTracks = topTracks.tracks.slice(0, 5).map(track => track.id);
                    const recommendedTracks = await getRecommendedTracks(seedTracks);
                    tracks = recommendedTracks;
                    currentTrackIndex = -1;
                    playNext();
                }
            } catch (error) {
                console.error('Error fetching artist recommendations:', error);
            }
        }

        document.getElementById('login-button').addEventListener('click', login);

        document.getElementById('like-btn').addEventListener('click', () => {
            likedTracks.push(tracks[currentTrackIndex].id);
            saveToPlaylist();
            playNext();
        });

        document.getElementById('dislike-btn').addEventListener('click', () => {
            dislikedTracks.push(tracks[currentTrackIndex].id);
            playNext();
        });

        document.getElementById('search-btn').addEventListener('click', () => {
            const artistName = document.getElementById('artist-input').value;
            if (artistName) {
                searchForArtist(artistName);
            } else {
                alert("Por favor, ingresa el nombre de un artista.");
            }
        });

        window.addEventListener('load', () => {
            accessToken = getAccessTokenFromUrl();
            if (accessToken) {
                document.getElementById('login-button').classList.add('hidden');
                document.getElementById('controls').classList.remove('hidden');
                document.getElementById('like-btn').classList.remove('hidden');
                document.getElementById('dislike-btn').classList.remove('hidden');
            }
        });
    </script>
</body>
</html>
