<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spotify Recommendations</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --spotify-green: #1DB954;
            --spotify-black: #191414;
            --spotify-gray: #535353;
        }

        body, html {
            margin: 0;
            padding: 0;
            font-family: 'Circular', 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--spotify-black);
            color: white;
            height: 100%;
            overflow: hidden;
        }

        #app {
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        #track-container {
            flex-grow: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        .track {
            position: absolute;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: transform 0.3s ease-out;
        }

        #album-cover {
            width: 80vw;
            height: 80vw;
            max-width: 300px;
            max-height: 300px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            margin-bottom: 20px;
        }

        #track-info {
            text-align: center;
            padding: 0 20px;
        }

        #track-name {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        #track-artist {
            font-size: 18px;
            color: #A0A0A0;
        }

        #controls {
            display: flex;
            justify-content: space-around;
            padding: 20px;
            background-color: rgba(25, 20, 20, 0.8);
        }

        .control-btn {
            background-color: transparent;
            border: none;
            color: white;
            font-size: 24px;
            padding: 10px;
            cursor: pointer;
        }

        #like-btn, #dislike-btn {
            position: absolute;
            bottom: 80px;
            right: 20px;
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        #dislike-btn {
            bottom: 140px;
        }

        #login-button {
            display: block;
            width: 80%;
            max-width: 300px;
            margin: 20px auto;
            padding: 15px;
            font-size: 18px;
            background-color: var(--spotify-green);
            color: white;
            border: none;
            border-radius: 30px;
            cursor: pointer;
        }

        .hidden {
            display: none !important;
        }

        #search-container {
            padding: 10px;
            background-color: var(--spotify-gray);
        }

        #search-toggle {
            background-color: var(--spotify-green);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 16px;
        }

        #artist-search {
            margin-top: 10px;
        }

        #artist-input {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 20px;
            background-color: white;
            color: var(--spotify-black);
        }

        #artist-suggestions {
            background-color: white;
            border-radius: 10px;
            margin-top: 10px;
            max-height: 200px;
            overflow-y: auto;
        }

        .artist-suggestion {
            padding: 10px;
            cursor: pointer;
            color: var(--spotify-black);
        }

        .artist-suggestion:hover {
            background-color: rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body>
    <div id="app">
        <div id="search-container">
            <button id="search-toggle">Search Artist</button>
            <div id="artist-search" class="hidden">
                <input type="text" id="artist-input" placeholder="Search for an artist...">
                <div id="artist-suggestions" class="hidden"></div>
            </div>
        </div>
        <div id="track-container" class="hidden">
            <div class="track">
                <img id="album-cover" src="/placeholder.svg" alt="Album Cover">
                <div id="track-info">
                    <div id="track-name"></div>
                    <div id="track-artist"></div>
                </div>
            </div>
        </div>
        <button id="like-btn" class="control-btn hidden"><i class="fas fa-heart"></i></button>
        <button id="dislike-btn" class="control-btn hidden"><i class="fas fa-times"></i></button>
        <div id="controls" class="hidden">
            <button id="prev-btn" class="control-btn"><i class="fas fa-step-backward"></i></button>
            <button id="play-pause-btn" class="control-btn"><i class="fas fa-play"></i></button>
            <button id="next-btn" class="control-btn"><i class="fas fa-step-forward"></i></button>
        </div>
        <button id="login-button">Login with Spotify</button>
    </div>
    <script>
        const clientId = 'b6a4fbf9f4fc4646b8862fc9d157d071';
        const redirectUri = 'https://mguibas.github.io/Spotify-songs-recomendation-page/';
        const scopes = 'user-top-read user-read-recently-played playlist-modify-private playlist-read-private';

        let accessToken;
        let userId;
        let playlistId;
        let currentTrackIndex = -1;
        let tracks = [];
        let likedTracks = [];
        let dislikedTracks = [];
        let audio = new Audio();

        function login() {
            const authUrl = `https://accounts.spotify.com/authorize?response_type=token&client_id=${clientId}&redirect_uri=${encodeURIComponent(redirectUri)}&scope=${encodeURIComponent(scopes)}`;
            window.location.href = authUrl;
        }

        function getAccessTokenFromUrl() {
            const params = new URLSearchParams(window.location.hash.replace('#', '?'));
            return params.get('access_token');
        }

        async function fetchWebApi(endpoint, method, body) {
            if (!accessToken) {
                console.error('No access token available');
                return null;
            }
            try {
                const res = await fetch(`https://api.spotify.com/${endpoint}`, {
                    headers: {
                        Authorization: `Bearer ${accessToken}`,
                    },
                    method,
                    body: JSON.stringify(body)
                });
                if (!res.ok) throw new Error(`HTTP error! Status: ${res.status}`);
                return await res.json();
            } catch (error) {
                console.error('Error fetching API:', error);
                return null;
            }
        }

        async function getUserId() {
            if (!userId) {
                const userData = await fetchWebApi('v1/me', 'GET');
                if (userData) userId = userData.id;
            }
            return userId;
        }

        async function getOrCreatePlaylist() {
            if (!playlistId) {
                const playlists = await fetchWebApi('v1/me/playlists', 'GET');
                if (playlists) {
                    const playlist = playlists.items.find(pl => pl.name === 'Recomendaciones Spotify');
                    
                    if (playlist) {
                        playlistId = playlist.id;
                    } else {
                        const newPlaylist = await fetchWebApi(`v1/users/${await getUserId()}/playlists`, 'POST', {
                            name: 'Recomendaciones Spotify',
                            description: 'Playlist creada automÃ¡ticamente para canciones de la web que ha hecho marquitos, Miau',
                            public: false
                        });
                        if (newPlaylist) playlistId = newPlaylist.id;
                    }
                }
            }
            return playlistId;
        }

        async function saveToPlaylist() {
            const track = tracks[currentTrackIndex];
            if (!track) return;
            const playlist = await getOrCreatePlaylist();
            await fetchWebApi(`v1/playlists/${playlist}/tracks`, 'POST', {
                uris: [track.uri]
            });
            console.log(`Saved to playlist: ${track.name} by ${track.artists.map(artist => artist.name).join(', ')}`);
        }

        async function getRecommendedTracks(seedTracks) {
            const seed = seedTracks.map(track => track.id).join(',');
            try {
                const recommendations = await fetchWebApi(`v1/recommendations?limit=10&seed_tracks=${seed}`, 'GET');
                if (recommendations) return recommendations.tracks.filter(track => track.preview_url && !dislikedTracks.includes(track.id));
            } catch (error) {
                console.error('Error getting recommended tracks:', error);
            }
            return [];
        }

        async function loadMoreTracks() {
            let seedTracks = tracks.length > 0 ? tracks.slice(-5) : await fetchWebApi('v1/me/top/tracks?limit=5', 'GET').then(data => data.items);
            seedTracks = [...seedTracks, ...likedTracks];
            const newTracks = await getRecommendedTracks(seedTracks);
            tracks.push(...newTracks);
        }

        async function playNext() {
            currentTrackIndex++;
            
            if (currentTrackIndex >= tracks.length) {
                await loadMoreTracks();
            }

            if (tracks[currentTrackIndex]) {
                playTrack(tracks[currentTrackIndex]);
            }
        }

        function playPrevious() {
            if (currentTrackIndex > 0) {
                currentTrackIndex--;
                playTrack(tracks[currentTrackIndex]);
            }
        }

        function playTrack(track) {
            if (track && track.preview_url) {
                document.getElementById('track-name').innerText = track.name;
                document.getElementById('track-artist').innerText = track.artists.map(artist => artist.name).join(', ');
                document.getElementById('album-cover').src = track.album.images[0].url;
                
                audio.src = track.preview_url;
                audio.play();
                updatePlayPauseButton();
            } else {
                console.log('Track or preview URL not available.');
            }
        }

        function updatePlayPauseButton() {
            const playPauseBtn = document.getElementById('play-pause-btn');
            if (audio.paused) {
                playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
            } else {
                playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
            }
        }

        function togglePlayPause() {
            if (audio.paused) {
                audio.play();
            } else {
                audio.pause();
            }
            updatePlayPauseButton();
        }

        function likeTrack() {
            const track = tracks[currentTrackIndex];
            if (track) {
                likedTracks.push(track.id);
                saveToPlaylist();
                playNext();
            }
        }

        function dislikeTrack() {
            const track = tracks[currentTrackIndex];
            if (track) {
                dislikedTracks.push(track.id);
                playNext();
            }
        }

        async function searchArtists(query) {
            if (query.trim() === '') return [];
            const response = await fetchWebApi(`v1/search?q=${encodeURIComponent(query)}&type=artist&limit=5`, 'GET');
            return response.artists.items;
        }

        async function fetchRecommendationsByArtist(artistId) {
            const recommendations = await fetchWebApi(`v1/recommendations?limit=10&seed_artists=${artistId}`, 'GET');
            if (recommendations && recommendations.tracks) {
                tracks = recommendations.tracks.filter(track => track.preview_url);
                currentTrackIndex = -1;
                playNext();
            } else {
                console.log('No recommendations found for this artist.');
            }
        }

        let debounceTimer;

        function setupArtistSearch() {
            const artistInput = document.getElementById('artist-input');
            const artistSuggestions = document.getElementById('artist-suggestions');

            artistInput.addEventListener('input', async (e) => {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(async () => {
                    const query = e.target.value;
                    if (query) {
                        const suggestions = await searchArtists(query);
                        displayArtistSuggestions(suggestions);
                    } else {
                        artistSuggestions.innerHTML = '';
                        artistSuggestions.classList.add('hidden');
                    }
                }, 300);
            });
        }

        function displayArtistSuggestions(suggestions) {
            const artistSuggestions = document.getElementById('artist-suggestions');
            artistSuggestions.innerHTML = '';

            if (suggestions.length > 0) {
                suggestions.forEach(artist => {
                    const div = document.createElement('div');
                    div.className = 'artist-suggestion';
                    div.textContent = artist.name;
                    div.addEventListener('click', () => {
                        fetchRecommendationsByArtist(artist.id);
                        document.getElementById('artist-input').value = '';
                        artistSuggestions.innerHTML = '';
                        artistSuggestions.classList.add('hidden');
                    });
                    artistSuggestions.appendChild(div);
                });
                artistSuggestions.classList.remove('hidden');
            } else {
                artistSuggestions.classList.add('hidden');
            }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            accessToken = getAccessTokenFromUrl();
            
            if (accessToken) {
                document.getElementById('login-button').classList.add('hidden');
                document.getElementById('track-container').classList.remove('hidden');
                document.getElementById('controls').classList.remove('hidden');
